"use strict";var O=Object.defineProperty;var le=Object.getOwnPropertyDescriptor;var ce=Object.getOwnPropertyNames;var me=Object.prototype.hasOwnProperty;var pe=(n,r)=>{for(var e in r)O(n,e,{get:r[e],enumerable:!0})},ue=(n,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let i of ce(r))!me.call(n,i)&&i!==e&&O(n,i,{get:()=>r[i],enumerable:!(t=le(r,i))||t.enumerable});return n};var _e=n=>ue(O({},"__esModule",{value:!0}),n);var we={};pe(we,{AbletonLive:()=>B,AutomationState:()=>H,Clip:()=>h,ClipSlot:()=>d,ClipType:()=>W,CrossfadeAssign:()=>U,Device:()=>C,DeviceParameter:()=>m,DeviceType:()=>Q,LaunchMode:()=>X,LaunchQuantization:()=>Y,MixerDevice:()=>T,Note:()=>k,PanningMode:()=>J,ParameterState:()=>F,PlayingStatus:()=>z,Quantization:()=>re,RawClipKeys:()=>x,RawClipSlotKeys:()=>g,RawDevice:()=>K,RawDeviceParameterKeys:()=>p,RawMixerDeviceKeys:()=>V,RawSceneKeys:()=>D,RawTrackKeys:()=>b,RecordingQuantization:()=>ie,SMPTE:()=>ne,ScaleName:()=>se,Scene:()=>y,Song:()=>S,SongView:()=>R,Track:()=>_,TrackFoldState:()=>te,TrackMonitoringState:()=>ee,TrackType:()=>G,WarpMode:()=>Z});module.exports=_e(we);function j(n){return{all:n=n||new Map,on:function(r,e){var t=n.get(r);t?t.push(e):n.set(r,[e])},off:function(r,e){var t=n.get(r);t&&(e?t.splice(t.indexOf(e)>>>0,1):n.set(r,[]))},emit:function(r,e){var t=n.get(r);t&&t.slice().map(function(i){i(e)}),(t=n.get("*"))&&t.slice().map(function(i){i(r,e)})}}}var P=class{constructor(r){this.mitt=j(r)}get all(){return this.mitt.all}on(r,e){this.mitt.on(r,e)}off(r,e){this.mitt.off(r,e)}emit(r,e){this.mitt.emit(r,e)}};var A=class extends P{constructor({maxAttempts:e=20,timeout:t=1e3}={}){super();this.num=0;this.maxAttempts=e,this.timeout=t}open(e,t=[]){try{this.ws=new WebSocket(e,t)}catch{this.emit("error",new Event("error"));return}this.url=e,this.protocols=t,this.ws.addEventListener("message",i=>{this.emit("message",i)}),this.ws.addEventListener("open",i=>{this.emit("open",i),this.num=0,clearTimeout(this.timer)}),this.ws.addEventListener("close",i=>{switch(i.code){case 1e3:case 1001:case 1005:this.emit("close",i),clearTimeout(this.timer);break;case 1006:default:this.num===0&&this.emit("close",i),this.reconnect(i)}}),this.ws.addEventListener("error",i=>{this.emit("error",i)})}get state(){return this.ws.readyState}reconnect(e){this.num++<this.maxAttempts?this.timer=setTimeout(()=>{this.emit("reconnect",this.num),this.open(this.url,this.protocols)},this.timeout||1e3):this.emit("close",e)}json(e){this.ws.send(JSON.stringify(e))}send(e){this.ws.send(e)}close(e=1e3,t="General"){console.log("[AbletonLive] Closing Connection"),this.timer&&clearTimeout(this.timer),this.ws.close(e,t)}};var M=require("node:crypto");var q="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var be=128,v,f;function de(n){!v||v.length<n?(v=Buffer.allocUnsafe(n*be),M.webcrypto.getRandomValues(v),f=0):f+n>v.length&&(M.webcrypto.getRandomValues(v),f=0),f+=n}function I(n=21){de(n-=0);let r="";for(let e=f-n;e<f;e++)r+=q[v[e]&63];return r}var c=class{constructor(r,e,t,i,s){this.ableton=r;this.ns=e;this._path=t;this.childrenInitialProps=i;this._id=s;this._state=new Map;this.getterTransformers={};this.childrenTransformers={}}get id(){return this._id}get path(){return this._path}async get(r){let e=await this.ableton.get(this.path,r,this._id),t=this.getterTransformers[r],i=e;return e!==null&&t&&(i=t(e)),i}async children(r,e,t){let i;this.childrenInitialProps&&(i=this.childrenInitialProps[r]),e&&(i=i.concat(e));let s=await this.ableton.getChildren(this.path,{child:r,initialProps:i,index:t},this._id),o=this.childrenTransformers[r];return s!==null&&o?o(s):s}async child(r,e,t){return(await this.children(r,t,e)??[])[0]}async set(r,e){return this.ableton.set(this.path,r,e,this._id)}async observe(r,e){let t=r,i=this.childrenTransformers[t],s=this.getterTransformers[t],o,l=u=>{e(u!==null&&i?i(u):u!==null&&s?s(u):u)};return this.childrenInitialProps?(o=this.childrenInitialProps[t],this.ableton.observe(this.path,r,l,{initialProps:o,liveObjectId:this._id})):this.ableton.observe(this.path,r,l,{liveObjectId:this._id})}async call(r,e,t){return this.ableton.call(this.path,{parameters:e,method:r},this._id,t)}async callMultiple(r,e){return this.ableton.callMultiple(this.path,r,this._id,e)}};var H=(t=>(t.None="none",t.Overridden="overridden",t.Playing="playing",t))(H||{}),F=(t=>(t.Disabled="disabled",t.Enabled="enabled",t.Irrelevant="irrelevant",t))(F||{}),p=["name","value","is_quantized"],m=class n extends c{constructor(e,t,i){super(e,"device_parameter",i||n.path);this.raw=t;this._id=t.id,this._name=t.name,this._value=t.value,this._isQuantized=t.is_quantized}static{this.path="live_set tracks N devices M parameters L"}get name(){return this._name}get value(){return this._value}get isQuantized(){return this._isQuantized}async reEnableAutomation(){return this.call("re_enable_automation",[])}async strForValue(e){return this.call("str_for_value",[e])}async str(){return this.call("__str__",[])}};var U=(t=>(t[t.A=0]="A",t[t.none=1]="none",t[t.B=2]="B",t))(U||{}),J=(e=>(e[e.Stereo=0]="Stereo",e[e.SplitStereo=1]="SplitStereo",e))(J||{}),V=[{name:"volume",initialProps:p},{name:"panning",initialProps:p}],he={volume:p,panning:p,sends:p},T=class n extends c{constructor(e,t,i){super(e,"mixer_device",i||n.path,he);this.raw=t;this._id=t.id,this._volume=new m(this.ableton,t.volume),this._panning=new m(this.ableton,t.panning),this.childrenTransformers={sends:s=>s.map(o=>new m(this.ableton,o))}}static{this.path="live_set tracks $1 mixer_device"}get volume(){return this._volume}get panning(){return this._panning}};var k=class n{static{this.MinDuration=1/128}constructor(r,e,t,i,s={}){let o=Object.assign({id:void 0,muted:!1,probability:1,velocityDeviation:0,releaseVelocity:64},s);this._pitch=r,this._start=e,this._duration=t,this._velocity=i,this._muted=o.muted,this._probability=o.probability,this._velocityDeviation=o.velocityDeviation,this._releaseVelocity=o.releaseVelocity,this._id=o.id}get id(){return this._id}get pitch(){return Math.min(Math.max(this._pitch,0),128)}get start(){return this._start}get duration(){return this._duration<=n.MinDuration?n.MinDuration:this._duration}get velocity(){return Math.min(Math.max(this._velocity,0),128)}get muted(){return!!this._muted}get probability(){return this._probability}get velocityDeviation(){return this._velocityDeviation}get releaseVelocity(){return this._releaseVelocity}get serialize(){return{pitch:this.pitch,start_time:this.start,duration:this.duration,velocity:this.velocity,mute:Number(this.muted),probability:this.probability,velocity_deviation:this.velocityDeviation,release_velocity:this.releaseVelocity,note_id:this._id}}clone(){return new n(this._pitch,this._start,this._duration,this._velocity,{id:void 0,muted:this._muted,probability:this._probability,velocityDeviation:this._velocity,releaseVelocity:this._releaseVelocity})}get[Symbol.toStringTag](){return`Note: ${this.pitch} <${this.id}>`}};var E=class n extends c{static{this.path="live_set tracks $1 clip_slots $2 clip view"}static getPath(r,e){return n.path.replace("$1",`${r}`).replace("$2",`${e}`)}constructor(r){super(r,"clip view",n.path)}async hideEnvelope(){return this.call("hide_envelope")}async showEnvelope(){return this.call("show_envelope")}async showLoop(){return this.call("show_loop")}};var Z=(l=>(l[l.Beats=0]="Beats",l[l.Tones=1]="Tones",l[l.Texture=2]="Texture",l[l.RePitch=3]="RePitch",l[l.Complex=4]="Complex",l[l.Rex=5]="Rex",l[l.ComplexPro=6]="ComplexPro",l))(Z||{}),X=(i=>(i[i.Trigger=0]="Trigger",i[i.Gate=1]="Gate",i[i.Toggle=2]="Toggle",i[i.Repeat=3]="Repeat",i))(X||{}),Y=(e=>(e[e.global=0]="global",e[e.none=1]="none",e[e["8m"]=2]="8m",e[e["4m"]=3]="4m",e[e["2m"]=4]="2m",e[e["1m"]=5]="1m",e[e["2n"]=6]="2n",e[e["2nt"]=7]="2nt",e[e["4n"]=8]="4n",e[e["4nt"]=9]="4nt",e[e["8n"]=10]="8n",e[e["8nt"]=11]="8nt",e[e["16n"]=12]="16n",e[e["16nt"]=13]="16nt",e[e["32n"]=14]="32n",e))(Y||{}),W=(e=>(e.Midi="midi",e.Audio="audio",e))(W||{}),x=["name","is_audio_clip","length"],h=class n extends c{constructor(e,t,i){super(e,"clip",i??t.path);this.raw=t;this._id=parseInt(t.id,10),this._name=t.name,this._type=t.is_audio_clip?"midi":"audio",this._length=t.length,this.childrenTransformers={clipView:()=>new E(this.ableton)}}static{this.sessionPath="live_set tracks $1 clip_slots $2 clip"}static{this.arrangementPath="live_set tracks $1 arrangement_clips $2 clip"}static getSessionPath(e,t){return n.sessionPath.replace("$1",`${e}`).replace("$2",`${t}`)}static getArrangementPath(e,t){return n.arrangementPath.replace("$1",`${e}`).replace("$2",`${t}`)}async removeSelectedNotes(e){await Promise.all(e.map(t=>this.removeNotes(t.start,t.duration,t.pitch,1)))}get name(){return this._name}get type(){return this._type}get length(){return this._length}async addNewNotes(e){return this.call("add_new_notes",[this.prepareNotes(e)])}async applyNoteModifications(e){return this.call("apply_note_modifications",[this.prepareNotes(e)])}async clearAllEnvelopes(){return this.call("clear_all_envelopes")}async clearEnvelope(e){return this.call("clear_envelope",[e])}async crop(){return this.call("crop")}async deselectAllNotes(){return this.call("deselect_all_notes")}async duplicateLoop(){return this.call("duplicate_loop")}async duplicateRegion(e,t,i,s=-1,o=0){return this.call("duplicate_region",[e,t,i,s,o])}async fire(){return this.call("fire")}async getNotes(e=0,t=256,i=0,s=127){return this.call("get_notes_extended",[i,s,e.toFixed(3),t.toFixed(3)]).then(this.parseNotes.bind(this))}async getNotesById(e){return this.call("get_notes_by_id",[...e]).then(this.parseNotes.bind(this))}async getSelectedNotes(){return this.call("get_selected_notes_extended").then(this.parseNotes.bind(this))}async movePlayingPos(e){return this.call("move_playing_pos",[e])}async quantize(e,t){return this.call("quantize",[e,t])}async quantizePitch(e,t,i){return this.call("quantize_pitch",[e,t,i])}async removeNotes(e=0,t=256,i=0,s=127){return this.call("remove_notes_extended",[i,s,e.toFixed(4),t.toFixed(4)])}async removeNotesById(e){return this.call("remove_notes_by_id",[...e])}async scrub(e){return this.call("scrub",[e])}async selectAllNotes(){return this.call("select_all_notes")}async setFireButtonState(e){return this.call("set_fire_button_state",[e])}async stop(){return this.call("stop")}async stopScrub(){return this.call("stop_scrub")}prepareNotes(e){return{notes:e.map(t=>t.serialize)}}parseNotes(e){let t=JSON.parse(e).notes.map(i=>new k(i.pitch,i.start_time,i.duration,i.velocity,{id:i.note_id,muted:!!i.mute,probability:i.probability,velocityDeviation:i.velocity_deviation,releaseVelocity:i.release_velocity}));return t.sort((i,s)=>i.start-s.start),t}};var z=(t=>(t[t.Stop=0]="Stop",t[t.Playing=1]="Playing",t[t.PlayingOrRecording=2]="PlayingOrRecording",t))(z||{}),g=["has_clip",{name:"clip",initialProps:x}],ve={clip:x},d=class extends c{constructor(e,t,i){super(e,"clip_slot",i??t.path,ve);this.raw=t;this._id=t.id,this._hasClip=t.has_clip,this._clip=new h(this.ableton,t.clip),this.childrenTransformers={clip:([s])=>s.id==="0"?null:new h(this.ableton,s)}}static{this.path="live_set tracks $1 clip_slots $2"}get hasClip(){return this._hasClip}async clip(){return this._clip?Promise.resolve(this._clip):await this.children("clip")}async createClip(e=4){return await this.call("create_clip",[e]),await this.children("clip")}async deleteClip(){return this.call("delete_clip")}async duplicateClipTo(e){return this.call("create_clip",[e])}async fire(e,t){return this.call("fire",[e,t])}async stop(){return this.call("stop")}};var Q=(i=>(i.AudioEffect="audio_effect",i.Instrument="instrument",i.MidiEffect="midi_effect",i.Undefined="undefined",i))(Q||{}),K=["name","type","class_name","class_display_name"],ge={parameters:p},C=class n extends c{constructor(e,t,i){super(e,"device",i||n.path,ge);this.raw=t;this._id=parseInt(t.id,10),this._name=t.name,this._type=t.type,this._className=t.class_name,this._classDisplayName=t.class_display_name,this.childrenTransformers={parameters:s=>s.map(o=>new m(this.ableton,o))}}static{this.path="live_set tracks $1 devices"}get name(){return this._name}get className(){return this._className}get classDisplayName(){return this._classDisplayName}get type(){return this._type}};var ee=(t=>(t[t.In=0]="In",t[t.Auto=1]="Auto",t[t.Off=2]="Off",t))(ee||{}),te=(e=>(e[e.Visible=0]="Visible",e[e.Hidden=1]="Hidden",e))(te||{}),G=(e=>(e.Midi="midi",e.Audio="audio",e))(G||{}),b=["name","has_audio_input"],ye={devices:K,clip_slots:g,mixer_device:V};function N(n){return r=>typeof r=="number"?r:JSON.parse(r)[n]}var _=class n extends c{constructor(e,t,i){super(e,"track",i??t.path,ye);this.raw=t;this._id=parseInt(t.id,10),this._name=t.name,this._type=t.has_audio_input?"audio":"midi",this.getterTransformers={available_input_routing_channels:N("available_input_routing_channels"),available_input_routing_types:N("available_input_routing_types"),available_output_routing_channels:N("available_output_routing_channels"),available_output_routing_types:N("available_output_routing_types")},this.childrenTransformers={devices:s=>s.map(o=>new C(this.ableton,o)),mixer_device:([s])=>new T(this.ableton,s),clip_slots:s=>s.map(o=>new d(this.ableton,o))}}static{this.path="live_set tracks $1"}static getPath(e){return n.path.replace("$1",`${e}`)}async getClips(){let e=await this.children("clip_slots");return await Promise.all(e.filter(t=>t.hasClip).map(async t=>await t.clip()))}async getClip(e){let t=await this.children("clip_slots");return e<1||e>t.length?Promise.reject(null):await t[e-1].clip()}async getOrCreateClip(e,t=4){let i=await this.children("clip_slots");if(console.log(e,i.length),e<1||e>i.length)return Promise.reject(null);let s=i[e-1];return s.hasClip?await s.clip():await s.createClip(t)}async isGroupTrack(){return typeof await this.get("available_input_routing_channels")=="number"}get name(){return this._name}get type(){return this._type}async volume(){return(this._mixerDevice=await this.children("mixer_device")).volume}async panning(){return(this._mixerDevice=await this.children("mixer_device")).panning}async deleteDevice(e){return this.call("delete_device",[e])}async duplicateClipSlot(e){return this.call("duplicate_clip_slot",[e])}async stopAllClips(){return this.call("stop_all_clips")}async deleteClip(e){return this.call("delete_clip",[`id ${e.id}`])}async duplicateClipToArrangement(e,t){return this.call("duplicate_clip_to_arrangement",[`id ${e.id}`,t])}async jumpInRunningSessionClip(e){return this.call("jump_in_running_session_clip",[e])}get[Symbol.toStringTag](){return`Track <${this.name}>`}};var D=["name","isEmpty"],Pe={clip_slots:g},y=class n extends c{constructor(e,t,i){super(e,"scene",i??t.path,Pe);this.raw=t;this._id=parseInt(t.id,10),this._name=t.name,this._isEmpty=t.isEmpty,this.childrenTransformers={clip_slots:s=>s.map(o=>new d(this.ableton,o))}}static{this.path="live_set scenes $1"}static getPath(e){return n.path.replace("$1",`${e}`)}get name(){return this._name}get isEmpty(){return this._isEmpty}async fire(e,t){return this.call("fire",[e,t])}async fireAsSelected(e){return this.call("fire_as_selected",[e])}async setFireButtonState(e){return this.call("set_fire_button_state",[e])}get[Symbol.toStringTag](){return`${this.name}`}};var re=(r=>(r[r.none=0]="none",r[r["8m"]=1]="8m",r[r["4m"]=2]="4m",r[r["2m"]=3]="2m",r[r["1m"]=4]="1m",r[r["2n"]=5]="2n",r[r["2nt"]=6]="2nt",r[r["4n"]=7]="4n",r[r["4nt"]=8]="4nt",r[r["8n"]=9]="8n",r[r["8nt"]=10]="8nt",r[r["16n"]=11]="16n",r[r["16nt"]=12]="16nt",r[r["32n"]=13]="32n",r))(re||{}),ie=(r=>(r[r.none=0]="none",r[r["4n"]=1]="4n",r[r["8n"]=2]="8n",r[r["8nt"]=3]="8nt",r[r["8n_8nt"]=4]="8n_8nt",r[r["16n"]=5]="16n",r[r["16nt"]=6]="16nt",r[r["16n_16nt"]=7]="16n_16nt",r[r["32n"]=8]="32n",r))(ie||{}),ne=(o=>(o[o.FramePosition=0]="FramePosition",o[o.Smpte24=1]="Smpte24",o[o.Smpte25=2]="Smpte25",o[o.Smpte30=3]="Smpte30",o[o.Smpte30Drop=4]="Smpte30Drop",o[o.Smpte29=5]="Smpte29",o))(ne||{}),se=(a=>(a.Major="Major",a.Minor="Minor",a.Dorian="Dorian",a.Mixolydian="Mixolydian",a.Lydian="Lydian",a.Phrygian="Phrygian",a.Locrian="Locrian",a.Diminished="Diminished",a["Whole-half"]="Whole-half",a["Whole Tone"]="Whole Tone",a["Minor Blues"]="Minor Blues",a["Minor Pentatonic"]="Minor Pentatonic",a["Major Pentatonic"]="Major Pentatonic",a["Harmonic Minor"]="Harmonic Minor",a["Melodic Minor"]="Melodic Minor",a["Super Locrian"]="Super Locrian",a.Bhairav="Bhairav",a["Hungarian Minor"]="Hungarian Minor",a["Minor Gypsy"]="Minor Gypsy",a.Hirojoshi="Hirojoshi",a["In-Sen"]="In-Sen",a.Iwato="Iwato",a.Kumoi="Kumoi",a.Pelog="Pelog",a.Spanish="Spanish",a))(se||{}),fe={scenes:D,tracks:b,master_track:b,return_tracks:b,return_track:b,visible_tracks:b,visible_track:b},S=class n extends c{static{this.path="live_set"}constructor(r){super(r,"song",n.path,fe),this.childrenTransformers={master_track:e=>new _(this.ableton,e,"live_set master_track"),tracks:e=>e.map(t=>new _(this.ableton,t)),scenes:e=>e.map(t=>new y(this.ableton,t)),return_tracks:e=>e.map(t=>new _(this.ableton,t)),visible_tracks:e=>e.map(t=>new _(this.ableton,t))}}async findTrackByName(r){return(await this.children("tracks")).find(t=>t.name.includes(r))}async getAudioTracks(){return(await this.children("tracks")).filter(e=>e.type==="audio")}async getMidiTracks(){return(await this.children("tracks")).filter(e=>e.type==="midi")}async playScene(r){let t=(await this.children("scenes"))[r-1];t&&await t.fire()}async captureAndInsertScene(){return this.call("capture_and_insert_scene")}async captureMidi(r=0){return this.call("capture_midi",[r])}async continuePlaying(){return this.call("continue_playing")}async createAudioTrack(r=-1){return this.call("create_audio_track",[r])}async createMidiTrack(r=-1){return this.call("create_midi_track",[r])}async createReturnTrack(){return this.call("create_return_track")}async createScene(r=-1){return this.call("create_scene",[r])}async deleteReturnTrack(r){return this.call("delete_return_track",[r])}async deleteScene(r){return this.call("delete_scene",[r])}async deleteTrack(r){return this.call("delete_track",[r])}async duplicateScene(r){return this.call("duplicate_scene",[r])}async duplicateTrack(r){return this.call("duplicate_track",[r])}async forceLinkBeatTime(){return this.call("force_link_beat_time")}async getBeatsLoopLength(){return this.call("get_beats_loop_length")}async getBeatsLoopStart(){return this.call("get_beats_loop_start")}async getCurrentBeatsSongTime(){return this.call("get_current_beats_song_time")}async getCurrentSmpteSongTime(r){return this.call("get_current_smpte_song_time",[r])}async isCuePointSelected(){return this.call("is_cue_point_selected")}async jumpBy(r){return this.call("jump_by",[r])}async jumpToNextCue(){return this.call("jump_to_next_cue")}async jumpToPrevCue(){return this.call("jump_to_prev_cue")}async playSelection(){return this.call("play_selection")}async reEnableAutomation(){return this.call("re_enable_automation")}async redo(){return this.call("redo")}async scrubBy(r){return this.call("scrub_by",[r])}async setOrDeleteCue(){return this.call("set_or_delete_cue")}async startPlaying(){return this.call("start_playing")}async stopAllClips(r=!0){return this.call("stop_all_clips",[r])}async stopPlaying(){return this.call("stop_playing")}async tapTempo(){return this.call("tap_tempo")}async triggerSessionRecord(r){return this.call("trigger_session_record",r?[r]:void 0)}async undo(){return this.call("undo")}};var xe={detail_clip:x,highlighted_clip_slot:g,selected_parameter:p,selected_scene:D,selected_track:b},R=class n extends c{static{this.path="live_set view"}constructor(r){super(r,"song",n.path,xe),this.childrenTransformers={selected_track:e=>new _(this.ableton,Array.isArray(e)?e[0]:e),selected_scene:e=>new y(this.ableton,Array.isArray(e)?e[0]:e),selected_parameter:e=>new m(this.ableton,Array.isArray(e)?e[0]:e),highlighted_clip_slot:e=>new d(this.ableton,Array.isArray(e)?e[0]:e),detail_clip:e=>new h(this.ableton,Array.isArray(e)?e[0]:e)}}async selectTrack(r){return this.set("selected_track",`id ${r.id}`)}async selectScene(r){return this.set("selected_scene",`id ${r.id}`)}async selectClip(r){return this.set("detail_clip",`id ${r.id}`)}async selectParameter(r){return this.set("selected_parameter",`id ${r.id}`)}async selectClipSlot(r){return this.set("highlighted_clip_slot",`id ${r.id}`)}async selectDevice(r){return this.call("select_device",[`id ${r}`])}};var B=class extends P{constructor({host:e="127.0.0.1",port:t=9001,logRequests:i=!1}={}){super();this.messageBus=new Map;this.eventListeners=new Map;this._isConnected=!1;this.song=new S(this);this.songView=new R(this);if(this._host=e,this._port=t,this._logRequests=i,this._isBrowser=typeof window<"u",(!this._isBrowser||window.WebSocket===void 0)&&global.WebSocket===void 0)throw new Error("[AbletonLive]: WebSocket implementation not available");this.client=new A,this.handleIncoming=this.handleIncoming.bind(this)}async connect(){return new Promise((e,t)=>{this.client.on("open",()=>{this._isConnected=!0,console.log(`[AbletonLive] Listening on ${this._host}/ableton-live:${this._port}`),this.emit("connect"),e()}),this.client.on("error",i=>{t(new Error(i.message))}),this.client.on("close",i=>{console.log(`[AbletonLive] Disconnected with code ${i.code}`),this.closeClient()}),this.client.on("reconnect",i=>{console.log(`[AbletonLive] Attempt to reconnect #${i}`)}),this.client.on("message",this.handleIncoming),this.client.open(`ws://${this._host}:${this._port}/ableton-live`),this._isBrowser&&window.addEventListener("beforeunload",()=>{console.log("[AbletonLive] Disconnected by reload"),this.closeClient()})})}get isConnected(){return this._isConnected}closeClient(){this._isConnected=!1,this.client.close(),this.emit("disconnect")}close(){this.messageBus.clear(),this.eventListeners.size&&(this.sendRaw({action:"close"}),this.eventListeners.clear()),this._isConnected=!1,this.client.close(),this.emit("disconnect")}disconnect(){this.close()}sendRaw(e){if(!this._isConnected)throw new Error("[Ableton Live]: Client not connected to the server");this.client.json(e)}handleIncoming(e){try{let t=JSON.parse(e.data),i=this.messageBus.get(t.uuid);if(this._logRequests&&console.log(t),t.event==="success"&&i)return this.messageBus.delete(t.uuid),i(null,t.result);if(t.event==="callback"&&t.result.listeners){t.result.listeners.map(s=>{let o=this.eventListeners.get(s);o&&o(t.result.data)});return}if(t.event==="error"&&i)return this.messageBus.delete(t.uuid),i(new Error(t.result));if(t.event==="disconnect"){this.close();return}}catch(t){console.log(`[AbletonLive] ${t.stack}`)}}async sendCommand(e,t,i,s={},o=2e3){if(!this._isConnected)throw new Error("[Ableton Live]: Client not connected to the server");return new Promise((l,u)=>{Object.keys(s).forEach(w=>s[w]===void 0&&delete s[w]);let $=I(),L={uuid:$,objectId:i,action:e,path:t,args:s};this._logRequests&&console.log("Command:",L);let oe=setTimeout(()=>u(new Error("Timeout")),o);this.messageBus.set($,(w,ae)=>{if(w){u(w);return}clearTimeout(oe),l(ae)}),this.sendRaw(L)})}async get(e,t,i){return this.sendCommand("get",e,i,{prop:t})}async getChildren(e,t,i){return this.sendCommand("children",e,i,t)}async set(e,t,i,s){return this.sendCommand("set",e,s,{prop:t,value:i})}async observe(e,t,i,{initialProps:s,liveObjectId:o}={}){let l=I(),u=`${e} ${t}`;return await this.sendCommand("observe",e,o,{objectPath:u,property:t,eventId:l,initialProps:s})===l&&this.eventListeners.set(l,i),async()=>await this.removeObserser(e,t,l,o)}async call(e,t,i,s){return this.sendCommand("call",e,i,t,s)}async callMultiple(e,t,i,s){return this.sendCommand("callMultiple",e,i,{calls:t},s)}async removeObserser(e,t,i,s){await this.sendCommand("removeObserver",e,s,{eventId:i,objectPath:`${e} ${t}`}),this.eventListeners.delete(i)}};0&&(module.exports={AbletonLive,AutomationState,Clip,ClipSlot,ClipType,CrossfadeAssign,Device,DeviceParameter,DeviceType,LaunchMode,LaunchQuantization,MixerDevice,Note,PanningMode,ParameterState,PlayingStatus,Quantization,RawClipKeys,RawClipSlotKeys,RawDevice,RawDeviceParameterKeys,RawMixerDeviceKeys,RawSceneKeys,RawTrackKeys,RecordingQuantization,SMPTE,ScaleName,Scene,Song,SongView,Track,TrackFoldState,TrackMonitoringState,TrackType,WarpMode});
